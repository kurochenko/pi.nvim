*pi.txt*    Pi coding agent integration for Neovim

Author:   Andrej Kurocenko
License:  MIT
Requires: Neovim >= 0.10, pi CLI

==============================================================================
CONTENTS                                                       *pi-contents*

  1. Introduction ...................... |pi-introduction|
  2. Installation ...................... |pi-installation|
  3. Configuration ..................... |pi-configuration|
  4. Modes ............................. |pi-modes|
  5. Commands .......................... |pi-commands|
  6. Keymaps ........................... |pi-keymaps|
  7. Context Placeholders .............. |pi-context|
  8. Named Prompts ..................... |pi-prompts|
  9. Statusline ........................ |pi-statusline|
 10. Lua API ........................... |pi-api|
 11. Health Check ...................... |pi-health|

==============================================================================
1. INTRODUCTION                                            *pi-introduction*

pi.nvim integrates the Pi coding agent into Neovim. It supports two modes:

  - **RPC mode** (default): Spawns `pi --mode rpc` as a subprocess and
    renders the conversation in a native Neovim buffer with real-time
    streaming. No terminal emulation — pure Lua integration.

  - **Terminal mode** (legacy): Opens pi's TUI in a Neovim terminal split.
    Communication via keystroke injection (chansend).

RPC mode is recommended. It provides model/thinking controls, proper
streaming display, extension UI handling, and no typing lag.

==============================================================================
2. INSTALLATION                                            *pi-installation*

Prerequisites:
  - Neovim >= 0.10
  - pi CLI installed and in PATH (https://pi.dev)
  - Optional: snacks.nvim (enhanced input UI)

Using lazy.nvim: >lua
  {
    "kurochenko/pi.nvim",
    config = function()
      require("pi").setup()
    end,
  }
<

==============================================================================
3. CONFIGURATION                                          *pi-configuration*

Call `require("pi").setup(opts)` with any of these options:

>lua
  require("pi").setup({
    -- Communication mode: "rpc" (default) or "terminal" (legacy)
    mode = "rpc",

    -- RPC mode settings
    rpc = {
      cmd = "pi",              -- Pi executable
      args = {},               -- Extra args for pi --mode rpc
      continue_session = true, -- Pass -c flag (continue previous session)
      auto_start = true,       -- Start RPC process on setup
      position = "right",      -- Chat buffer: "left", "right", "bottom"
      size = 0.4,              -- Fraction of screen (0.0-1.0)
    },

    -- Terminal mode settings (only used when mode = "terminal")
    terminal = {
      position = "right",
      size = 0.4,
      cmd = "pi",
      continue_session = true,
      auto_start = false,
      send_delay = 50,
      startup_timeout = 5000,
      max_retries = 10,
      clear_before_send = true,
    },

    -- Context placeholders (set to false to disable)
    contexts = {
      ["@this"] = true,
      ["@buffer"] = true,
      ["@buffers"] = true,
      ["@visible"] = true,
      ["@diagnostics"] = true,
      ["@quickfix"] = true,
      ["@diff"] = true,
    },

    -- Named prompts (set to false to remove)
    prompts = {
      explain = { text = "Explain @this and its context", submit = true },
      review = { text = "Review @this for correctness and readability", submit = true },
      fix = { text = "Fix @diagnostics", submit = true },
      test = { text = "Add tests for @this", submit = true },
      document = { text = "Add documentation comments to @this", submit = true },
      optimize = { text = "Optimize @this for performance and readability", submit = true },
      implement = { text = "Implement @this", submit = true },
      diff = { text = "Review the git diff: @diff", submit = true },
    },

    -- Input dialog settings
    ask = {
      prompt = "pi> ",
      snacks = {},  -- Snacks.input window options
    },

    -- Keymaps (set to false to disable)
    keymaps = {
      toggle = "<leader>pt",         -- Toggle chat panel
      ask = "<leader>pa",            -- Ask about code/selection
      select = "<leader>px",         -- Action picker
      prompt_this = "<leader>pp",    -- Send code context
      abort = "<leader>pq",          -- Abort current operation
      model = "<leader>pm",          -- Model picker
      cycle_model = "<leader>pn",    -- Cycle to next model
      cycle_thinking = "<leader>pk", -- Cycle thinking level
    },

    -- Events
    events = {
      reload = true,  -- Auto-reload buffers on external changes
    },
  })
<

==============================================================================
4. MODES                                                        *pi-modes*

RPC MODE (default)                                           *pi-mode-rpc*

Spawns `pi --mode rpc` as a subprocess. Communication via JSON over
stdin/stdout. The conversation is rendered in a native Neovim buffer
(markdown filetype with treesitter highlighting).

Features:
  - Real-time streaming (thinking + text deltas)
  - Model switching and thinking level control
  - Session management (new, stats, export)
  - Extension UI handling (dialogs, notifications)
  - Statusline integration
  - No terminal overhead, no typing lag

TERMINAL MODE (legacy)                                  *pi-mode-terminal*

Opens pi's TUI in a Neovim terminal split. Communication via bracketed
paste and keystroke injection (chansend).

Set `mode = "terminal"` in config to use this mode.

==============================================================================
5. COMMANDS                                                  *pi-commands*

:Pi [subcmd]                                                         *:Pi*

  :Pi                 Toggle the pi panel
  :Pi toggle          Toggle the pi panel
  :Pi ask [text]      Open input dialog (optional default text)
  :Pi prompt {text}   Send a named prompt or raw text
  :Pi select          Open the action picker
  :Pi abort           Abort current operation
  :Pi model           Open model picker
  :Pi cycle-model     Cycle to next model
  :Pi thinking        Cycle thinking level
  :Pi session new     Start a new session
  :Pi session stats   Show session statistics
  :Pi stats           Show session statistics (alias)
  :Pi export          Export session to HTML
  :Pi restart         Restart the RPC process

==============================================================================
6. KEYMAPS                                                    *pi-keymaps*

Default keymaps (all configurable, set to false to disable):

  <leader>pt  Toggle pi panel (normal + terminal mode)
  <leader>pa  Ask about code (normal) / Ask about selection (visual)
  <leader>px  Action picker (normal + visual)
  <leader>pp  Send code context reference (normal + visual)
  <leader>pq  Abort current operation (normal)
  <leader>pm  Model picker (normal)
  <leader>pn  Cycle to next model (normal)
  <leader>pk  Cycle thinking level (normal)

In the chat buffer:
  q           Close the chat window

==============================================================================
7. CONTEXT PLACEHOLDERS                                      *pi-context*

Context placeholders are expanded in prompt text:

  @this         Selected code, or code around cursor (±5 lines)
  @buffer       Full current buffer content (truncated at 500 lines)
  @buffers      All loaded file buffers with 3-line previews
  @visible      Content visible in all windows
  @diagnostics  LSP diagnostics for the current buffer
  @quickfix     Quickfix list entries
  @diff         Git diff output

Example: `"Review @this for bugs"` expands @this to the selected code
with file path and line numbers in a markdown code fence.

==============================================================================
8. NAMED PROMPTS                                            *pi-prompts*

Named prompts are predefined templates available via `:Pi prompt` and
the action picker. They support context placeholders.

Add custom prompts: >lua
  require("pi").setup({
    prompts = {
      security = { text = "Audit @this for security issues", submit = true },
    },
  })
<

Remove built-in prompts: >lua
  require("pi").setup({
    prompts = {
      optimize = false,  -- remove the optimize prompt
    },
  })
<

==============================================================================
9. STATUSLINE                                              *pi-statusline*

pi.nvim provides statusline functions via `require("pi.status")`:

>lua
  -- Individual components
  require("pi.status").model()     -- "Claude Sonnet 4"
  require("pi.status").thinking()  -- "high"
  require("pi.status").state()     -- "streaming"|"idle"|"disconnected"
  require("pi.status").cost()      -- "$0.0500"

  -- Complete string
  require("pi.status").statusline()
  -- → "Pi: Claude Sonnet 4 [high] ● streaming"

  -- Boolean check
  require("pi.status").is_connected()  -- true/false
<

Lualine integration: >lua
  require("lualine").setup({
    sections = {
      lualine_x = { require("pi.status").lualine },
    },
  })
<

==============================================================================
10. LUA API                                                      *pi-api*

require("pi").setup({opts})           Configure and initialize
require("pi").toggle()                Toggle the pi panel
require("pi").ask([text], [{opts}])   Open input dialog
require("pi").prompt({text}, [{opts}]) Send prompt directly
require("pi").select()                Open action picker
require("pi").abort()                 Abort current operation
require("pi").pick_model()            Open model picker
require("pi").cycle_model()           Cycle to next model
require("pi").cycle_thinking()        Cycle thinking level
require("pi").new_session()           Start new session
require("pi").session_stats()         Show session statistics
require("pi").export_html()           Export session to HTML
require("pi").send_context()          Send code context reference
require("pi").operator({prefix})      Operator function for dot-repeat

Low-level modules:
  require("pi.rpc")         RPC subprocess management
  require("pi.events")      Event dispatcher and state tracking
  require("pi.chat")        Chat buffer rendering
  require("pi.stream")      Streaming text handler
  require("pi.status")      Statusline integration
  require("pi.context")     Context capture and placeholders
  require("pi.extension_ui") Extension UI request handling
  require("pi.terminal")    Terminal mode (legacy)

==============================================================================
11. HEALTH CHECK                                              *pi-health*

Run `:checkhealth pi` to verify:
  - Neovim version (>= 0.10)
  - pi CLI installation and version
  - snacks.nvim availability
  - setup() status
  - Current mode (rpc/terminal)
  - RPC process status and model info

==============================================================================
vim:tw=78:ft=help:norl:
